$(window).on("load resize", function () {
  if ($(window).width() < 767) {
    $(".slider-advantages:not(.slick-initialized)").slick({
      arrows: false,
      dots: true,
      infinite: true,
      speed: 100,
      slidesToShow: 1
    });
    $(".box:not(.slick-initialized)").slick({
      dots: true,
      arrows: false,
      infinite: true,
      speed: 100,
      slidesToShow: 1
    });
  } else {
    $(".slider-advantages.slick-initialized, .box.slick-initialized").slick("unslick");

    deletClassMobile();
  }
});
$("#nav-icon1").click(function () {
  $("header nav").slideToggle();
  $("header").toggleClass("open-menu");
  $("#nav-icon1").toggleClass("open");
});

function deletClassMobile() {
  $("header nav").hide();
  $("header").removeClass("open-menu");
  $("#nav-icon1").removeClass("open");
}

$(".first-slider").slick({
  slide: ".first-slider__item",
  dots: false,
  infinite: true,
  speed: 300,
  prevArrow: ".left",
  nextArrow: ".right",
  variableWidth: true
});

// current

$(".btn--consult").magnificPopup({
  fixedContentPos: false,
  callbacks: {
    beforeOpen: function beforeOpen() {
      $("body").css({
        "overflow-y": "hidden"
      });
    },
    close: function close() {
      $("body").css({
        "overflow-y": "scroll"
      });
    }
  }
});
$(".navigation").on("click", "a", function (t) {
  var e = $(this).attr("data-scroll"),
    o = $(e).offset().top;
  console.log(o);
  $("body,html").animate({
      scrollTop: o + 50
    },
    500
  );
});
var $page = $("html, body");
$('a[class*="btn--scroll"]').click(function (e) {
  e.preventDefault();
  $page.animate({
      scrollTop: $($.attr(this, "href")).offset().top
    },
    1500
  );
  return false;
});

// render
var href = document.location.href;
console.warn("href", href);
// https://iphone-cases.in.ua/games/index.php?cat=art
var regex = /[?&]([^=#]+)=([^&#]*)/g,
  url = href,
  url_params = {},
  match;
while ((match = regex.exec(url))) {
  url_params[match[1]] = match[2];
}
/* if (href.indexOf('games') > -1){
        console.warn("games");
        } */
var url_cat = "";
for (var param in url_params) {
  if (param == "cat") {
    url_cat = url_params[param];
  }
  console.log("param " + param + " value " + url_params[param]);
}

console.warn("href params", url_params);

function urlcat() {
  // проверяем есть ли в параметрах ссылки категория
  var urlcat = "";
  for (var cat in casesByCategories) {
    //console.log("cat "+cat+" value "+casesByCategories[cat]);

    if (url_cat == cat) {
      //console.log("url has cat "+param+" value "+url_params[param]);
      console.log("url has cat " + url_cat);
      // запускаем отображение категории из параметра ссылки
      urlcat = url_cat;
    }
  }
  if (urlcat != "") {
    return urlcat;
  } else {
    return false;
  }
}

function init() {
  casesByCategories = {};
  casesArr.forEach(item => {
    if (item.collection in casesByCategories) {
      casesByCategories[item.collection].push(item);
      //console.table(item);
    } else {
      casesByCategories[item.collection] = [item];
    }
  });
}

function render(items) {
  return (
    items
    // item.img
    .map(
      item =>
      '<div class="box__item" data-cat="' +
      item.collection +
      '">' +
      '<div class="img-wrap">' +
      '<img class="card__img product__img" src="' +
      item.img +
      '">' +
      "</div>" +
      '<div class="box-body">' +
      '<p class="name">' +
      item.name +
      "</p>" +
      '<p class="price">' +
      item.price +
      "ugr" +
      "</p>" +
      '<p class="art">' +
      item.atr +
      "</p>" +
      '<div class="d-flex">' +
      '<div class="current"></div>' +
      '<button class="btn--buy" data-sb-product-name="' +
      item.name +
      '">В корзину</button>' +
      "</div>" +
      "</div>" +
      "</div>"
    )
    .join("")
  );
}
// '<input type="number" value="1"></input>' +
//           '<div class="current__btn">' +
//           '<span class="plus"></span>' +
//           '<span class="minus"></span>'
function hideUsersButton(more) {
  //var next = getTotalSize();
  //var next = more;
  var next = remainedValueButton.innerHTML;
  if (parseInt(next) < 1) {
    if (nextUsersButton.classList) nextUsersButton.classList.add("hide");
    else nextUsersButton.className += " " + className;
    nextUsersButton.style.display = "none";
  } else {
    if (nextUsersButton.classList) nextUsersButton.classList.remove("hide");
    else
      nextUsersButton.className = nextUsersButton.className.replace(
        new RegExp(
          "(^|\\b)" + className.split(" ").join("|") + "(\\b|$)",
          "gi"
        ),
        " "
      );
    nextUsersButton.style.display = "";
  }
  console.log("more " + more);
  console.log("remainedValueButton " + remainedValueButton.innerHTML);
}

const nextUsersButton = document.querySelector("#next-users");
const remainedValueButton = document.querySelector("#remained-value");
const selectCollection = document.querySelector("#select");
const usersDiv = document.querySelector("#box");

a = casesArr.reverse();

let casesByCategories = {};

// BEHAVIOUR

nextUsersButton.addEventListener("click", () => {
  if (selectCollection.value === "all") {
    usersDiv.innerHTML += render(getRandomFromAllCategories(4));
    remainedValueButton.innerHTML = getTotalSize();
  } else {
    usersDiv.innerHTML += render(getFromCategory(selectCollection.value, 4));
    remainedValueButton.innerHTML =
      casesByCategories[selectCollection.value].length;
  }

  hideUsersButton(getTotalSize());
});

function getRandomFromAllCategories(count) {
  const categories = Object.keys(casesByCategories);
  let index = 0;
  const items = [];
  while (getTotalSize() > 0) {
    const categorizedItems = casesByCategories[categories[index]];
    index++;
    if (categorizedItems.length > 0) items.push(categorizedItems.shift());
    if (items.length === count) break;
    if (index >= categories.length) index = 0;
  }
  console.warn("render random");
  console.table(items);
  return items;
}

function getFromCategory(categoryName, count) {
  if (categoryName in casesByCategories) {
    return casesByCategories[categoryName].splice(0, count);
  }
  console.warn("Category", categoryName, "does not exist!");
  return [];
}

function getTotalSize() {
  const categories = Object.keys(casesByCategories);
  let sum = 0;
  categories.forEach(category => (sum += casesByCategories[category].length));
  return sum;
}

$("#catalog .select-box").append(
  '<div id="catsel" class="custom-select"><span>Категория все:</span><ul></ul></div>'
);

$("head").append(
  '<style>.custom-select span{display:inline-block;cursor:pointer}.custom-select ul li{cursor:pointer}.custom-select ul li:last-child{border-bottom:none}#catalog .select-box #select{position: absolute; top: -55555px; right: -55555px;} .add2cart.btn{background: #393939 !important;} .modal-dialog .btc-group .btn-submit { display: none; } .bline { text-align: center; padding-bottom: 10px;} .bline span { font-size: 13px; } .empty_model {display: none; text-align: center; font-size: 12px; color: red;} @media (max-width: 1024px) { .custom-select { margin: 10px auto 0 auto;} .bline { width: 100%;}} .dop_wrap{display:none}.dop_wrap .dop{background:0 0}.x-cart-overlay .x-title{padding:30px;margin:0}.x-title{margin:0 0 15px;font-size:24px;font-weight:400}.x-shc-item__content{display:table;width:100%;table-layout:fixed}.x-shc-item__image-cell{display:table-cell;width:100px;padding-right:20px;vertical-align:top;text-align:center;font-size:0}.x-shc-item__image{vertical-align:middle;max-height:100px}.x-shc-item__info-cell{display:table-cell;vertical-align:top}.x-shc-item__main-info-cell{display:table-cell;padding-right:20px;vertical-align:top;width:180px}.x-shc-item__info .model_wrap{display:table-cell;width:180px;padding-right:20px;vertical-align:top}.x-shc-item__info .model_wrap{max-width:100%;width:100%}.x-shc-item__title-holder{position:relative;max-height:2.6em;line-height:1.3;overflow:hidden;font-weight:700}.x-shc-item__title-link{color:#333;text-decoration:none;font-weight:700}.x-shc-item__price-holder{margin:10px 0 0;color:#989898}.dop,.dop_wrap,.x-shc-item__price-holder,.x-shc-item__summary-cell .x-shc-item__cell-label{font-size:12px}.dop_img{width:40px}.x-shc-item__price{margin-right:10px}.x-shc-item__presence{margin:10px 0 0;color:#989898}.x-shc-item__labels-holder{margin:10px 0 0}.x-shc-item__quantity-cell{display:none;width:200px;padding-right:20px;vertical-align:top}.x-shc-item__cell-label{display:block;margin-bottom:10px}.x-quantity__holder{position:relative;overflow:hidden;width:94px;height:40px;padding:0 26px;-webkit-box-sizing:border-box;box-sizing:border-box;border:1px solid #dfe1f0;border-radius:2px}.x-quantity__button{position:absolute;top:0;bottom:0;background:#f6f8fd;width:26px;font-size:0}.x-quantity__button_type_minus{left:0}.x-quantity__button:before{position:absolute;top:50%;left:50%;height:2px;width:8px;margin:-1px 0 0 -4px;background:#000;content:""}.x-quantity__button_type_plus{right:0}.x-quantity__input{display:block;width:100%;padding:10px 0;border:none;line-height:18px;text-align:center}.x-shc-item__summary-cell{display:table-cell;width:50px;vertical-align:top}.x-shc-item__cell-label{display:block;margin-bottom:10px}.x-shc-item__summary-price{display:block;font-size:16px;font-weight:700}.x-shc-item__control-cell{display:table-cell;width:50px;padding-left:20px;vertical-align:top;text-align:left;position:relative}.x-shc-item__control{display:inline-block;vertical-align:middle;color:#989898}.x-shc-item__control-icon{display:inline-block;width:16px;height:16px;vertical-align:middle;fill:currentColor}.x-shc-item{padding-bottom:10px}.x-cart-overlay .x-shc-group{padding:20px 30px 40px}.x-shc-group{background:#fff}.x-cart-overlay .x-shc-total{padding:20px 0 0}.x-shc-total{padding:20px 20px 30px;line-height:1}.x-shc-total__info-wrapper{width:100%;text-align:right}.x-shc-total__label{display:block;margin:0 0 5px}.x-shc-total__price{display:block;font-size:24px;font-weight:700}.x-shc-total__controls-wrapper{margin:20px 0 0}.x-shc-total__main-control-holder span{color:#fff}.x-shc-total__main-control-holder{float:right}.x-shc-total__button{padding:0 45px;font-weight:700}.x-button_theme_dark-blue{background:#393939;border-color:#393939;color:#fff}.x-button{position:relative;overflow:hidden;display:inline-block;padding:0 20px;-webkit-box-sizing:border-box;box-sizing:border-box;border:1px solid #dfe1f0;border-radius:2px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:top;text-align:center;font-weight:400;font-size:0;color:#333;cursor:pointer;-webkit-transition:background .1s,border-color .1s,color .1s;-o-transition:background .1s,border-color .1s,color .1s;transition:background .1s,border-color .1s,color .1s;pointer-events:auto}.x-button:before{position:absolute;top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.2);opacity:0;-webkit-transition:opacity .1s;-o-transition:opacity .1s;transition:opacity .1s;content:""}.x-shc-total__button .x-button__text{font-size:14px;font-weight:700}.x-button__text{position:relative;display:inline-block;vertical-align:middle;line-height:1;font-size:13px}.x-shc-total__button:after{height:48px}.x-button:after{display:inline-block;height:38px;vertical-align:middle;content:""}.x-shc-total__continue-control-holder{display:inline-block;margin-right:30px}.x-shc-total__button_type_continue{padding:0 25px}.x-button_theme_purple.x-button_type_contour{color:#393939}.x-shc-total__button_type_continue{padding:0 25px;font-weight:400}.x-button_theme_purple{border-color:#393939}.x-shc-total__button_type_continue .x-button__text{font-weight:400}.modal-open .modal{overflow-x:hidden;overflow-y:auto}.cart_wrap{position:fixed;top:0;right:0;bottom:0;left:0;z-index:1050;display:none;overflow:scroll;outline:0;-webkit-overflow-scrolling:touch}body.modal-open{overflow:hidden}.fade.in{opacity:1}.fade{opacity:0;-webkit-transition:opacity .15s linear;-o-transition:opacity .15s linear;transition:opacity .15s linear}.cart_wrap.fade .modal-dialog{-webkit-transition:-webkit-transform .3s ease-out;transition:-webkit-transform .3s ease-out;-o-transition:-o-transform .3s ease-out;transition:transform .3s ease-out;transition:transform .3s ease-out,-webkit-transform .3s ease-out,-o-transform .3s ease-out;-webkit-transform:translate(0,-25%);-ms-transform:translate(0,-25%);-o-transform:translate(0,-25%);transform:translate(0,-25%)}.cart_wrap.in .modal-dialog{-webkit-transform:translate(0,0);-ms-transform:translate(0,0);-o-transform:translate(0,0);transform:translate(0,0)}.modal-dialog{position:relative;width:auto;margin:10px;background-color:#fff;padding:20px;border-radius:5px;z-index:5}@media (min-width:544px){.modal-dialog{max-width:900px;margin:30px auto}}.form-group{margin-bottom:1rem}.modal-close{position:absolute;right:15px;top:15px;font-family:"Lato Black";cursor:pointer;font-size:17px;color:#40b934}@media (max-width:768px){.modal{width:100%;padding:10px}}#order_send_form{margin-top:20px}.delete_product_icon svg{width:15px;height:15px;margin-top:10px;cursor:pointer}.name4print.alert input,.user-name.alert,.user-phone.alert,select#model.alert{border-color:#e6143c}@media (max-width:765px){.x-shc-item__info .model_wrap{display:block;width:100%;padding-right:0;position:relative;top:-10px}.x-shc-item__summary-cell{display:block;width:100%;vertical-align:middle}.x-shc-total__continue-control-holder{width:100%;display:inline-block;margin-right:0}.x-shc-total__main-control-holder{margin-top:20px;float:none;width:100%}.x-shc-item{padding-bottom:20px}.x-button_theme_purple.x-button_type_contour{width:100%}.x-shc-total__main-control-holder span{color:#fff;width:100%}}.name4print{margin-top:5px}.name4print label{font-size:12px;line-height:12px;display:block;padding-bottom:5px}.name4print input{margin-top:8px;display:block;width:100%;height:calc(2.25rem + 2px);padding:.375rem .75rem;font-size:1rem;line-height:1.5;color:#aaa;background-color:#fff;background-clip:padding-box;border:1px solid #ced4da;border-radius:1.45rem;-webkit-transition:border-color .15s;-o-transition:border-color .15s;transition:border-color .15s}.cart_wrap .qa-sc_list-buy_button .x-button__text.send,.cart_wrap.order_form .qa-sc_list-buy_button .x-button__text{display:none}.cart_wrap.order_form .qa-sc_list-buy_button .x-button__text.send{display:inline-block} .x-shc-total form input[type="image"]{position: absolute; top: -88888px; left: -88888px;} .form-check-input{position:absolute!important;z-index:888;opacity:1;margin:10px 0 0 0;width:20px;height:20px;display:block!important;cursor:pointer}</style>'
);
var html = [];
var catselt1 = "";
var disabled = 0;
$("#select option").each(function (i) {
  if ($(this).attr("disabled") !== undefined) {
    disabled = 1;
  }
});
$("#select option").each(function (i) {
  var dis = "";
  if ($(this).attr("disabled") !== undefined) {
    //dis = 'style="display: none;"';
    dis = 'class="all"';
    catselt1 = $(this).text();
  }
  var lit = "";
  if (dis == "") {
    lit = $(this).text();
  } else {
    lit = "Новинки";
  }

  html.push("<li " + dis + ' rel="' + $(this).val() + '">' + lit + "</li>");
  stripSelectText();
});

$("#catsel ul").html(html.join(""));

var $lists = $("#catsel");

function stripSelectText() {
  var tb = $(".custom-select span:eq(0)");
  var t = tb.text();
  var tl = parseInt(t.length);
  if (tl > 25) {
    var ft = t.substr(0, 22);
    var nt = ft + "...";
    tb.html(nt);
  }
  console.log("select text length " + tl);
}

$lists.on("click", function (e) {
  e.stopPropagation();
  $(this).toggleClass("open");
  console.log(this);
  $lists
    .not(this)
    .find("ul:visible")
    .hide();
  var $tgt = $(e.target);
  $(this)
    .find("ul")
    .slideToggle("fast");
  if ($tgt.is("li")) {
    var optv = $tgt.html();
    var td = ":";
    //	console.log('catselt1 - '+catselt1);
    if (catselt1.indexOf(":") > -1) {
      td = "";
    }
    if (href.indexOf("games") > -1) {
      lit = "catselt1 ";
    }
    //var optvf = '<span class="catseln">'+catselt1+'</span>'+td+' <span class="catselv">'+optv+'</span>';
    var optvf =
      '<span class="catseln"></span><span class="catselv">' + optv + "</span>";
    $(this)
      .find("span")
      .html(optvf);
    var value = $tgt.attr("rel");
    $("#select").val(value);
    stripSelectText();

    if (selectCollection.value == "all") {
      init();

      usersDiv.innerHTML = render(getRandomFromAllCategories(8));
      remainedValueButton.innerHTML = getTotalSize();
      hideUsersButton(getTotalSize());

      console.warn("getFromCategory all");
    } else {
      init();
      //	console.table('casesByCategories '+casesByCategories[selectCollection.value]);
      usersDiv.innerHTML = render(getFromCategory(selectCollection.value, 4));
      remainedValueButton.innerHTML =
        casesByCategories[selectCollection.value].length;
      hideUsersButton(casesByCategories[selectCollection.value].length);
    }

    console.log("update");
  }
});

$(document).click(function (e) {
  $lists.find("ul:visible").hide();
});

init();

var cat_from_url = urlcat();
if (cat_from_url) {
  $("#catsel ul li").each(function () {
    var so = $(this).attr("rel");
    // console.warn("so "+so);
    if (so == cat_from_url) {
      console.warn("catsel has url cat");
      $(this).click();
      $("#catsel ul").hide();
    }
  });

  console.warn("render from url");
} else {
  //window.all_list_random = render(getRandomFromAllCategories(8));
  window.all_list_random = render(getFromCategory("iPhoneX", 4));
  usersDiv.innerHTML += window.all_list_random;
  window.all_list_random_size = getTotalSize();
  remainedValueButton.innerHTML = window.all_list_random_size;
}

console.log("ready");